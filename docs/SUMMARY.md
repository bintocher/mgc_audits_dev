# MGC Audits - Итоговая сводка проекта

## Документация проекта

Полная проектная документация состоит из следующих файлов:

1. **SUMMARY.md** (этот файл) - краткая сводка проекта
2. **PROJECT_DESIGN.md** - детальное описание архитектуры, бизнес-логики и модели данных
3. **PROJECT_PLAN.md** - план разработки, оценка трудозатрат и роли в команде
4. **api_endpoints.md** - полная спецификация REST API

---

## Информация о системе
**MGC Audits** - веб-система для управления аудитами качества и несоответствиями, заменяющая существующую ISQ-AA.

### Ключевые возможности:
- Планирование и ведение аудитов
- Управление несоответствиями (findings) с полным жизненным циклом
- Настраиваемый workflow статусов
- Гибкая система ролей и прав (RBAC)
- Многопредприятийная архитектура
- Интеграция с Active Directory, Email (Yandex), Telegram
- Автоматические уведомления
- Отчетность (Excel)
- REST API для внешних систем
- Мультиязычность (русский, английский)

---

## Технологический стек

**Backend:**
- Python 3.13 + FastAPI + SQLAlchemy 2.0+
- PostgreSQL 18
- Redis 6.4 + Celery
- JWT авторизация
- Управление зависимостями: uv + uvx

**Frontend:**
- React 18 + TypeScript
- Ant Design
- Redux Toolkit

**Инфраструктура:**
- Docker + Docker Compose
- Nginx
- Ubuntu 22/24 LTS

---

## Сроки и стоимость

### Базовая разработка

| Параметр | Значение |
|----------|----------|
| Трудоемкость | 404 часа |
| Календарные сроки | 12 недель (2,5 месяца) |
| **Стоимость без НДС** | **1 198 000 ₽** |
| **Стоимость с НДС** | **1 437 600 ₽** |

### Команда разработки

| Роль | Дней | Часов | Ставка (₽/час) | Стоимость с НДС (₽) |
|------|------|-------|----------------|-------------------|
| Архитектор | 8 | 64 | 4 500 | 345 600 |
| DevOps | 5 | 40 | 3 000 | 144 000 |
| Фронтенд разработчик | 21 | 162 | 2 500 | 486 000 |
| Бэкенд разработчик | 13 | 98 | 2 500 | 294 000 |
| Руководитель проекта | 5 | 40 | 3 500 | 168 000 |

### Основные этапы

| Этап | Недели | Результат |
|------|--------|-----------|
| Подготовка, архитектура | 1 | ТЗ, архитектура, инфраструктура |
| Справочники, администрирование | 2-4 | Авторизация (email, OTP, LDAP), RBAC, справочники |
| Аудиты и Findings | 4-5 | Полная бизнес-логика, workflow |
| Frontend основные элементы | 5-8 | UI для всех модулей |
| Отчетность | 7-8 | 3 типа отчетов, экспорт |
| Тестирование | 8-9 | Стабильная система |
| MVP запуск | 10 | Система в эксплуатации |
| Исправления, документация | 11 | Доработка по ОС |
| Финальный запуск, обучение | 12 | Передача заказчику |


---

## Основные модули системы

### 1. Dashboard
Главный экран со счетчиками и задачами пользователя.

### 2. Audits (Аудиты)
Планирование аудитов, привязка к предприятиям, процессам, нормативам, аудиторам.

**Типы графиков аудитов (4 отдельных графика):**
1. **График аудитов продукта** - аудиты по деталям и компонентам производимых изделий
2. **График аудитов процесса и системы** - внутренние аудиты систем менеджмента, процессов
3. **График аудитов готовности проекта (LRA)** - Launch Readiness Audit для проверки готовности нового продукта к производству
4. **График внешних аудитов** - аудиты от клиентов, внешних организаций

**Планирование аудитов:**
- Создание планов аудитов на год/квартал с указанием типа графика
- Согласование плана на уровне Дивизиона и УК (управляющей компании)
- Календарь аудитов с визуализацией по неделям
- Назначение аудиторов с учетом их загрузки
- Управление квалификациями аудиторов
- Подтверждение квалификации и допуск к программе
- Перечень нормативных документов для доступа
- Тип сертификации
- Статистика по количеству проведенных аудитов в году

**График аудитов - структура ячеек:**
- Каждая ячейка графика соответствует одной неделе и одному аудиту
- **Ручной ввод** - пользователь вводит коды вех (LRA1, LRA2, SOP, CA, SA и т.д., максимум 100 символов с переносом строк)
- **Автоматические данные** - система рассчитывает результат аудита (Green/Yellow/Red или % для LRA, Ранг для CA и т.д.) и статус
- **Цветовая индикация** - автоматическая подкраска ячеек на основе результата, возможность переопределения цвета
- **Частичное автозаполнение** - система автоматически создает ячейки на основе дат аудита (audit_date_from, audit_date_to), но заполнение конкретных вех - ручное
- **Поддержка множественных локаций** - на одной неделе аудит может проходить на нескольких заводах/площадках одновременно

**Внешние аудиты - специфика:**
- Отслеживание ПКД (План-График Действий): плановая дата закрытия, фактическая дата, статус (open/in_progress/closed)
- Указание ответственного от организации (отдельно от аудитора)
- Поддержка различных форматов результатов (Green/Yellow/Red, Ранг, % и т.д.)

### 3. Findings (Несоответствия)
Жизненный цикл несоответствий:
- Статусы с цветовой индикацией
- 5xWhy анализ коренных причин
- Корректирующие и предупреждающие действия
- Сроки и контроль исполнения
- Комментарии и вложения
- Делегирование

### 4. Reports (Отчеты)
- Finding report (все несоответствия)
- Report by processes (по процессам)
- Report by solvers (по исполнителям)
- Экспорт: Excel
- Отправка на email

### 5. Planning (Планирование аудитов)
- Создание и управление планами аудитов
- Календарь аудитов с визуализацией
- Назначение аудиторов с проверкой загрузки
- Управление квалификациями аудиторов
- Отчеты по планированию и аудиторам

### 6. Administration (Администрирование)
- Пользователи и роли
- Предприятия
- Справочники (процессы, нормы, продукты, проекты)
- Workflow конструктор
- Настройки системы

---

## Модель данных (основные сущности)


### Ключевые таблицы:
- **Enterprise** - предприятия
- **Division** - дивизионы (подразделения)
- **Location** - локации (заводы, площадки)
- **User** - пользователи
- **Role, Permission** - роли и права
- **Dictionary** (Process, Norm, AuditType, Product, Project, Client, Shift, RiskLevel, AuditCategory) - справочники
- **Status, StatusTransition** - workflow с поддержкой цветов
- **AuditPlan** - планы аудитов (с категорией и согласованием)
- **AuditPlanItem** - пункты плана аудитов
- **AuditorQualification** - квалификация аудиторов
- **Audit** - аудиты (с поддержкой переносов, часов, результатов, категории, риска, вех)
- **AuditComponent** - компоненты (детали, узлы) в рамках аудита
- **AuditScheduleWeek** - ячейки графика аудитов (ручной + автоматический ввод по неделям)
- **AuditLocations** - M2M связь между аудитами и локациями (несколько заводов на аудит)
- **AuditClients** - M2M связь между аудитами и клиентами (для process_system и LRA)
- **AuditShifts** - M2M связь между аудитами и сменами (для process_system)
- **Finding** - несоответствия
- **FindingDelegation** - делегирование
- **FindingComment, FindingAttachment** - комментарии, файлы
- **ChangeHistory** - история изменений
- **Notification** - уведомления (с retry и логами ошибок)
- **NotificationQueue** - очередь уведомлений для батчевой обработки
- **SystemSetting** - настройки (с категориями и публичными настройками)
- **APIToken** - токены для API
- **S3Storage** - подключения к S3
- **EmailAccount** - SMTP аккаунты
- **LdapConnection** - LDAP подключения

Подробная схема БД в файле `PROJECT_DESIGN.md`.

---

## API

REST API с JWT авторизацией, `/api/v1`

### Основные группы:
- `/api/auth/*` - аутентификация (включая Telegram link/unlink)
- `/api/api_tokens/*` - управление API-токенами
- `/api/users/*` - пользователи
- `/api/roles/*` - роли и права
- `/api/enterprises/*` - предприятия
- `/api/divisions/*` - дивизионы
- `/api/locations/*` - локации (заводы)
- `/api/dictionaries/*` - справочники
- `/api/audits/*` - аудиты
- `/api/audits/calendar/*` - графики аудитов (по неделям, все 4 типа)
- `/api/audit_plans/*` - планы аудитов с согласованием
- `/api/findings/*` - findings
- `/api/workflow/*` - workflow
- `/api/reports/*` - отчеты
- `/api/dashboard/*` - dashboard
- `/api/notifications/*` - уведомления
- `/api/settings/*` - настройки
- `/api/integrations/*` - подключения S3/SMTP/LDAP
- `/api/change_history/*` - история изменений

Документация: Swagger/OpenAPI

Детальная спецификация в файле `api_endpoints.md`.

---

## Оптимизация и масштабируемость

### Партиционирование БД (PostgreSQL 18)

**Стратегия**: Таблицы с высоким объемом данных и частыми временными запросами партиционируются для ускорения:

| Таблица | Тип | Частота | Выигрыш |
|---------|-----|---------|---------|
| `audits` | RANGE по audit_date_from | Ежемесячно | 10-50x быстрее |
| `audit_components` | RANGE по created_at | Ежемесячно | 10-30x быстрее |
| `findings` | RANGE по created_at | Ежемесячно | 10-30x быстрее |
| `notifications` | RANGE по created_at | Ежедневно | 20-100x быстрее |
| `notification_queue` | RANGE по created_at | Еженедельно | 10-50x быстрее |
| `change_history` | RANGE по changed_at | Ежемесячно | 10-30x быстрее |

**Результат**: Запросы графика аудитов за период (~100-500 мс вместо 5-10 сек на 10M записей).

### Индексирование

- Все таблицы имеют оптимальные индексы для фильтрации и сортировки
- Индексы создаются внутри каждой партиции для максимальной производительности
- JSONB индексы для быстрого поиска в workflow конфигурациях

---

## Безопасность

### Аутентификация:
- Email + пароль (автогенерация: Слово-Слово-СловоЦифра)
- Email + OTP (одноразовый пароль)
- LDAP/Active Directory (сквозная авторизация)

### Авторизация:
- RBAC с настройкой CRUD прав на объекты
- Разделение по предприятиям
- Множественные роли на пользователя
- По умолчанию - все запрещено

### Сессии:
- Одна активная сессия на пользователя
- Настраиваемое время жизни
- Блокировка после N неудачных попыток

### API:
- JWT токены + refresh
- Rate limiting
- Кастомные права или привязка к пользователю

---

## Уведомления

### Каналы:
- **Email** - обязательно, отключить нельзя
- **Telegram** - опционально, настройка через уникальную ссылку

### События:
1. Создание finding с назначением
2. Изменение статуса
3. Приближение deadline
4. Просрочка deadline
5. Делегирование
6. Запрос на одобрение
7. Одобрение/отклонение
8. Добавление комментария

### Настройка:
Уведомления привязаны к событиям и ролям. Пользователь может привязать Telegram для получения сообщений.

### Батчевая обработка и масштабирование:
- Отправка уведомлений пачками через Celery
- Rate Limiting: Email (30/мин, 500/час), Telegram (30/сек, 20/мин на пользователя)
- Retry механизм с логированием ошибок (3 попытки: 1мин, 5мин, 15мин)
- FIFO обработка (первый пришел - первый ушел)
- Мониторинг очередей в пользовательской админке
- Настройки rate limiting через пользовательскую админку
- Статистика по доставкам за последние ≤7 дней по каналам и типам событий

---

## Workflow

Визуальный конструктор в админ-панели:

- Создание статусов с цветами
- Настройка разрешенных переходов
- Привязка ролей к переходам
- Валидация обязательных полей
- Обязательность комментариев
- Настройка уведомлений

---

## Мягкое удаление

Все сущности имеют поле `deleted_at`. Физическое удаление запрещено.

При отображении помеченных на удаление объектов добавляется суффикс `[X]` к названию.

---

## Мультиязычность

- Переводится только интерфейс
- Язык выбирается пользователем в профиле
- Поддерживаемые языки: русский (по умолчанию), английский

---

## Критерии приемки

### MVP (неделя 10):
- Вход по email+пароль, OTP и LDAP (сквозная авторизация)
- Создание и редактирование аудитов (все 4 типа: product, process_system, lra, external)
- 4 типа графиков аудитов с разделением по категориям
- Недельный график с ячейками для ручного ввода данных
- Редактирование ячеек графика (коды вех, комментарии, результаты)
- Автоматическое заполнение ячеек на основе дат аудита
- Создание и редактирование findings с 5xWhy
- Смена статусов с валидацией
- Делегирование findings
- Комментарии и вложения
- Email + Telegram уведомления
- Управление API-токенами (создание, ротация, отзыв), токены внешних систем
- Многоподключения S3/SMTP/LDAP с тестами подключения
- Статистика уведомлений (≤7 дней) и мониторинг очередей/ошибок
- Все 3 типа отчетов (Excel)
- Dashboard с актуальной статистикой
- RBAC настраивается через админку
- Workflow конструктор функционален
- Справочники создаются и заполняются в админке
- Согласование планов аудитов на уровне Дивизиона и УК
- Деплой на PROD

### Полная версия (неделя 12):
- Все замечания после MVP исправлены
- Система стабильна под нагрузкой
- Все справочники настраиваются через админку
- История изменений работает
- Прослеживаемость переносов аудитов для всех 4 типов графиков
- Мягкое удаление для всех сущностей
- API документация актуальна
- Техническая + пользовательская документация
- Обучение администраторов и пользователей
- Передача кода и доступов

---

## Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Задержка доступа к AD | Средняя | 0.5-1 нед | Запросить заранее |
| Изменение бизнес-правил | Средняя | +10-20 ч | Заморозить требования |
| Расширение отчетов | Низкая | +8-24 ч | Зафиксировать в ТЗ |
| Импорт данных | Средняя | +12-40 ч | Отдельная итерация |
| Инфраструктурные задержки | Низкая | 0.5 нед | Резерв времени |

---

## Следующие шаги

1. **Предоставить доступы:** сервер, SMTP, LDAP, Telegram бот
2. **Начать разработку** (неделя 1)

---

## Контакты

**Разработчик:**
- Разработка системы MGC Audits
- Срок: 12 недель (2,5 месяца)
- Трудоемкость: 404 часа
- **Стоимость: 1 198 000 ₽ (без НДС) / 1 437 600 ₽ (с НДС)**

**Команда:** 5 специалистов (Архитектор, Backend, Frontend, DevOps, Руководитель проекта)

**Дата подготовки документации:** 02.10.2025

---

## Приложения

1. `PROJECT_DESIGN.md` - архитектура и модель данных (детально)
2. `PROJECT_PLAN.md` - план разработки, API, оценка (детально)
3. `api_endpoints.md` - спецификация API

---

*Документация подготовлена на основе анализа презентации ISQ-AA и технических требований заказчика.*

